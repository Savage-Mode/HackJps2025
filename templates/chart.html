{% extends "base.html" %} 
{% block head %} 
{{super() }} 
<style>
  .ai-feedback-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    margin-bottom: 20px;
  }
  
  .comparative-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    border: none;
    color: white;
  }
  
  .code-block {
    background-color: #2d3748;
    color: #e2e8f0;
    border-radius: 8px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9em;
    line-height: 1.4;
  }
  
  .feedback-text {
    white-space: pre-wrap;
    line-height: 1.6;
  }
  
  .performance-metrics {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
  }
</style>
{% endblock %}

<body>
  {% block header %} {{ super() }} {% endblock %} 
  
  {% block content %}
  <div class="container-fluid">
    <!-- Performance Chart Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-center" style="gap: 100px; margin-bottom: 4px">
          <span class="fs-5 fw-semibold">Func1 Score: {{ avg1 }}</span>
          <span class="fs-5 fw-semibold">Func2 Score: {{ avg2 }}</span>
        </div>
        <canvas id="lineChart" height="100" class="rounded-3 px-5"></canvas>
      </div>
    </div>

    <!-- AI Feedback Section -->
    <div class="row">
      <!-- Function 1 Analysis -->
      <div class="col-lg-6 mb-4">
        <div class="card ai-feedback-card h-100">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-robot me-2"></i>AI Analysis - Function 1
            </h5>
          </div>
          <div class="card-body">
            <div class="performance-metrics">
              <strong>Performance Metrics:</strong><br>
              Score: {{ avg1 }}
            </div>
            
            <h6>Code:</h6>
            <pre class="code-block p-3"><code>{{ program1_code }}</code></pre>
            
            <h6 class="mt-3">AI Feedback:</h6>
            <div class="feedback-text">{{ ai_feedback1 }}</div>
          </div>
        </div>
      </div>

      <!-- Function 2 Analysis -->
      <div class="col-lg-6 mb-4">
        <div class="card ai-feedback-card h-100">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-robot me-2"></i>AI Analysis - Function 2
            </h5>
          </div>
          <div class="card-body">
            <div class="performance-metrics">
              <strong>Performance Metrics:</strong><br>
              Score: {{ avg2 }}
            </div>
            
            <h6>Code:</h6>
            <pre class="code-block p-3"><code>{{ program2_code }}</code></pre>
            
            <h6 class="mt-3">AI Feedback:</h6>
            <div class="feedback-text">{{ ai_feedback2 }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Comparative Analysis -->
    <div class="row">
      <div class="col-12">
        <div class="card comparative-card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-balance-scale me-2"></i>Comparative Analysis
            </h5>
          </div>
          <div class="card-body">
            <div class="performance-metrics">
              <strong>Head-to-Head Comparison:</strong><br>
              Function 1 Average: {{ avg1 }}s | Function 2 Average: {{ avg2 }}s<br>
              {% if avg1 < avg2 %}
                <span class="badge bg-success">Function 1 is {{ "%.2f"|format((avg2/avg1 - 1) * 100) }}% faster</span>
              {% else %}
                <span class="badge bg-success">Function 2 is {{ "%.2f"|format((avg1/avg2 - 1) * 100) }}% faster</span>
              {% endif %}
            </div>
            
            <h6 class="mt-3">AI Comparative Feedback:</h6>
            <div class="feedback-text">{{ comparative_feedback }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4">
      <div class="col-12 text-center">
        <a href="/benchmark" class="btn btn-primary btn-lg me-3">
          <i class="fas fa-code me-2"></i>Analyze New Functions
        </a>
        <button onclick="refreshFeedback()" class="btn btn-outline-secondary btn-lg">
          <i class="fas fa-refresh me-2"></i>Refresh AI Analysis
        </button>
      </div>
    </div>
  </div>

  <script>
    // Chart.js configuration
    var ctx = document.getElementById("lineChart").getContext("2d");
    var lineChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: {{ labels | safe }},
            datasets: [
                {
                    label: "Time for Program 1",
                    data: {{ program1 | safe }},
                    borderColor: "#FF0000",
                    backgroundColor: "rgba(255, 0, 0, 0.1)",
                    yAxisID: 'left',
                    fill: true
                },
                {
                    label: "Time for Program 2", 
                    data: {{ program2 | safe }},
                    borderColor: "#ff8a33",
                    backgroundColor: "rgba(255, 138, 51, 0.1)",
                    yAxisID: 'left',
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                left: {
                    type: 'linear',
                    position: 'left',
                    beginAtZero: true,
                    reverse: true,
                    label: "Time in Seconds"
                }
            }
        }
    });

    // Function to refresh AI feedback
    function refreshFeedback() {
        // Show loading indicator
        const feedbackElements = document.querySelectorAll('.feedback-text');
        feedbackElements.forEach(el => {
            el.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing AI analysis...';
        });

        // Make API call to refresh feedback
        fetch('/api/feedback')
            .then(response => response.json())
            .then(data => {
                // Update feedback sections
                const feedback1 = document.querySelector('.col-lg-6:first-child .feedback-text');
                const feedback2 = document.querySelector('.col-lg-6:last-child .feedback-text');
                const comparativeFeedback = document.querySelector('.comparative-card .feedback-text');
                
                if (feedback1) feedback1.textContent = data.ai_feedback1;
                if (feedback2) feedback2.textContent = data.ai_feedback2;
                if (comparativeFeedback) comparativeFeedback.textContent = data.comparative_feedback;
            })
            .catch(error => {
                console.error('Error refreshing feedback:', error);
                feedbackElements.forEach(el => {
                    el.innerHTML = '<span class="text-warning">Error refreshing feedback. Please try again.</span>';
                });
            });
    }

    // Auto-refresh feedback every 30 seconds (optional)
    // setInterval(refreshFeedback, 30000);
  </script>
  {% endblock %} 
  
  {% block footer %} {{ super() }} {% endblock %}
</body>